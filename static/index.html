<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Volatility Index Candlestick</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js core -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Financial plugin for candlesticks -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.5.0/dist/chartjs-chart-financial.min.js"></script>

  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h2>Volatility Index Candlestick <span id="index">R_75</span></h2>

  <div class="chart-scroll-wrapper">
    <div class="chart-container">
      <canvas id="candlestickChart"></canvas>
    </div>
  </div>

  <script>
    const index = "R_75";
    const socket = new WebSocket(
      `${location.protocol === "https:" ? "wss" : "ws"}://${location.host}/ws/${index}`
    );

    const ctx = document.getElementById("candlestickChart").getContext("2d");

    // Chart configuration
    const candlestickChart = new Chart(ctx, {
      type: "candlestick",
      data: {
        datasets: [
          {
            label: "Price",
            data: [],
            borderColor: "#00ffcc",
            backgroundColor: "#00ffcc33",
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        scales: {
          x: {
            type: "time",
            time: {
              unit: "minute",
              tooltipFormat: "HH:mm:ss",
              displayFormats: {
                minute: "HH:mm",
              },
            },
            ticks: {
              color: "#ccc",
            },
            grid: {
              color: "#333",
            },
          },
          y: {
            beginAtZero: false,
            ticks: {
              color: "#ccc",
            },
            grid: {
              color: "#333",
            },
          },
        },
        plugins: {
          legend: {
            labels: {
              color: "#00ffcc",
              font: {
                size: 14,
              },
            },
          },
          tooltip: {
            enabled: true,
            mode: "index",
            intersect: false,
            callbacks: {
              label: function (context) {
                const c = context.raw;
                return `O:${c.o}  H:${c.h}  L:${c.l}  C:${c.c}`;
              },
            },
          },
        },
      },
    });

    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.candle) {
        const c = data.candle;

        // Convert ISO date to timestamp for Chart.js financial plugin
        const timestamp = new Date(c.time).getTime();

        // Push new candle data point
        candlestickChart.data.datasets[0].data.push({
          x: timestamp,
          o: c.open,
          h: c.high,
          l: c.low,
          c: c.close,
        });

        // Keep max 60 candles (1 hour)
        if (candlestickChart.data.datasets[0].data.length > 60) {
          candlestickChart.data.datasets[0].data.shift();
        }

        candlestickChart.update();
      }
    };
  </script>
</body>
</html>
