<!DOCTYPE html>
<html>
<head>
    <title>Volatility Index Candlestick</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.5.0/dist/chartjs-chart-financial.min.js"></script>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <h2>Volatility Index <span id="index">R_75</span></h2>

    <div class="chart-scroll-wrapper">
        <div class="chart-container">
            <canvas id="chart" width="600" height="400"></canvas>
        </div>
    </div>

    <script>
        const index = "R_75";
        const socket = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws/${index}`);

        const ctx = document.getElementById('chart').getContext('2d');

        const chart = new Chart(ctx, {
            type: 'candlestick',
            data: {
                datasets: [{
                    label: 'Price',
                    data: []
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            tooltipFormat: 'HH:mm:ss',
                            displayFormats: { minute: 'HH:mm' }
                        },
                        ticks: {
                            color: '#ccc',
                        },
                        grid: {
                            color: '#333',
                        }
                    },
                    y: {
                        beginAtZero: false,
                        ticks: { color: '#ccc' },
                        grid: { color: '#333' }
                    }
                },
                plugins: {
                    legend: { labels: { color: '#00ffcc' } },
                    tooltip: {
                        enabled: true,
                        callbacks: {
                            label: ctx => {
                                const c = ctx.raw;
                                return `O:${c.o} H:${c.h} L:${c.l} C:${c.c}`;
                            }
                        }
                    }
                }
            }
        });

        // OHLC aggregation variables
        let currentCandle = null;
        let candles = [];

        function addTickToCandle(tick) {
            const tickTime = new Date(tick.epoch * 1000);
            // Align candle time to minute start (truncate seconds & ms)
            const candleTime = new Date(tickTime);
            candleTime.setSeconds(0, 0);

            const quote = tick.quote;

            if (!currentCandle || currentCandle.time.getTime() !== candleTime.getTime()) {
                // Push previous candle if exists
                if (currentCandle) {
                    candles.push(currentCandle);
                    if (candles.length > 30) candles.shift(); // keep last 30 candles
                }
                // Start new candle
                currentCandle = {
                    time: candleTime,
                    open: quote,
                    high: quote,
                    low: quote,
                    close: quote
                };
            } else {
                // Update current candle OHLC
                currentCandle.high = Math.max(currentCandle.high, quote);
                currentCandle.low = Math.min(currentCandle.low, quote);
                currentCandle.close = quote;
            }
        }

        function updateChart() {
            chart.data.datasets[0].data = candles.map(c => ({
                x: c.time.getTime(),
                o: c.open,
                h: c.high,
                l: c.low,
                c: c.close
            }));

            // Also include current candle if exists
            if (currentCandle) {
                chart.data.datasets[0].data.push({
                    x: currentCandle.time.getTime(),
                    o: currentCandle.open,
                    h: currentCandle.high,
                    l: currentCandle.low,
                    c: currentCandle.close
                });
            }

            chart.update();
        }

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.tick) {
                addTickToCandle(data.tick);
                updateChart();
            }
        };
    </script>
</body>
</html>
